# 브라우저에 데이터 저장하기

## 1. 쿠키

- 쿠키 또는 세션을 사용하는 이유
  - HTTP 프로토콜의 약점 보완
    - connectionless
      - 비연결성, 클라이언트와 서버가 한 번 연결을 맺은 후, 클라이언트 요청에 대해 서버가 응답을 마치면 맺었던 연결을 끊어 버리는 성질
      - HTTP 1.1 버전에서 연결을 유지하고, 재활용하는 기능이 추가 (keep-alive)
    - stateless
      - 무상태, 통신이 끝나면 상태를 유지하지 않는 특성
  
### 쿠키
- HTTP 쿠키(웹 쿠키, 브라우저 쿠키)는 서버가 사용자의 웹 브라우저에 전송하는 작은 데이터 조각이다.
- 브라우저는 그 데이터 조각들을 저장해 놓았다가, 동일한 서버에 재요청 시 저장된 데이터를 함께 전송한다.
- 사용 목적
  1. 세션 관리(Session management)
     : 서버에 저장해야 할 로그인, 장바구니, 게임 스코어 등의 정보 관리
  2. 개인화(Personalization)
     : 사용자 선호, 테마 등의 세팅
  3. 트래킹(Tracking)
     : 사용자 행동을 기록하고 분석하는 용도
- 속성
  - 라이프타임: 쿠키가 유지되는 시간
    - Expires: 속성에 정의된 날짜에 삭제
    - Max-Age: 속성에 정의된 날짜에 삭제
    - Expires와 Max-Age가 동시에 설정된 경우, Max-Age 속성 우선
    - 세션 쿠키: 라이프타임에 대한 명시가 없는 경우, 현재 세션이 끝날 때 삭제
  - 보안
    - Secure: HTTPS 요청일 경우에만 쿠키를 전송
      - HTTPS 프로토콜을 이용해 데이터를 암후화
      - 본질적으로 안전하지 않고, 이 플래그가 실질적인 보안을 제공하는 것은 아님
    - HttpOnly
      - HttpOnly 속성이 정의된 쿠키는 자바스크립트의 `documnet.cookie`를 통해 접근할 수 없도록 제한
      - CSS(Cross-Site Scripting) 공격 방어
    - SameSite
      - 크로스 사이트 요청의 경우 쿠키를 전송하지 않음
      - None / Lax / Static
      - CSRF(Cross-Site Request Forgery) 공격 방어
  - 스코프: 쿠키의 유효 범위
    - Domain
      - 도메인의 유효 범위, 쿠키가 전송될 호스트
      - 도메인이 정의되면 해당 도메인의 서브 도메인에서도 쿠키가 포함되어 전송되지만 정의되어 있지 않으면 현재 서버 주소가 기본 값으로 설정되며 서브 도메인은 포함되지 않는다.
    - Path
      - 쿠키의 디렉토리의 유효 범위
      - Path 속성 지정 시 서브 디렉토리에서도 쿠키가 포함되어 전송
- 모든 요청마다 쿠키가 함께 전송되기 때문에, 쿠키에 많은 데이터를 저장하게 되면 성능이 떨어지는 원인이 될 수 있다.
  - 정보를 클라이언트 측에 저장하기 위해서 Web Storage API (localStorage, sessionStorage)와 IndexedDB를 사용할 수 있다.


### 세션 쿠키
- 서버에서 관리
- 일정 시간동안 같은 사용자(브라우저)로부터 들어오는 일련의 요구를 하나의 상태로 보고, 그 상태를 일정하게 유지시키는 기술
  - 일정 시간: 방문자가 웹 브라우저를 통해 웹 서버에 접속한 시점으로부터 웹 브라우저를 종료하여 연결을 끝내는 시점
  - 즉, 방문자가 웹 서버에 접속해 있는 상태를 하나의 단위로 보고 이를 세션이라 한다.
- 사용자가 사이트에 로그인하면 유효기간이 끝날 때까지 더 이상 아이디와 비밀번호를 입력하지 않아도 되도록 사용자가 이미 서버로부터 인증받았음을 증명해주는 증서
- 동작 방식
  1. 클라이언트가 서버 접속 시 서버는 세션 ID를 발급하고 메모리에 아이디 사본을 기록
  2. 클라이언트는 쿠키를 사용해 세션 ID 저장
  3. 클라이언트가 서버에 다시 접속 시 이 쿠키를 이용해 세션 ID값을 서버에 전달하고, 서버는 사용자가 누구인지 확인한 뒤 요청을 처리
- Object 형식으로 데이터를 저장한다.
- 윈도우나 브라우저 탭을 닫을 때 제거된다.

### 토큰
- HTTP의 stateless, connectionless 특징 때문에 사용자 인증을 유지할 수 있는 기능이 필요
  - 쿠키는 브라우저에 사용자 정보가 기록되기 때문에 위변조의 가능성이 높아 보안에 취약
  - 세션은 서버의 메모리를 차지하기 때문에 동시접속자가 많아질 경우 서버 과부하의 원인이 되고, 세션 정보가 중간에 탈취당할 수 있다.
- 보호할 데이터를 토큰으로 치환해 원본 데이터 대신 토큰을 사용한다.
- 로그인한 유저에게 세션 아이디 대신 토큰을 발급해 상태를 저장하지 않고도 사용자의 로그인 여부를 파악할 수 있도록 한다.
- 토큰을 받아간 사용자가 이를 쿠키로 저장해두고 필요할 때마다 제시하면 서버는 자기가 발급한 토큰임을 알아보고 사용자의 요청을 허가한다.

### 캐시
- 서버 부하를 방지하기 위해 웹 문서, 이미지 등의 자원을 임시 사용자 웹 브라우저에 저장하는 기술로, 불필요한 데이터 요청 및 전송을 줄여 페이지 로딩 속도를 개선할 수 있다.
- 쿠키와 캐시의 차이
  - 쿠키와 캐시 모두 정보를 저장해 재활용하는 기술
  - 쿠키는 사용자의 수고를 덜어주는 것이 목적
  - 캐시는 데이터의 전송량을 줄이고 서비스 이용 속도를 높이는 것이 목적

#### CDN
- Content Delivery Network, 콘텐츠 전송 네트워크
- 여러 지역에 설치된 캐시 서버들을 사용해 본 서버로 들어오는 요청들을 분산 처리하는 서비스
- 캐시를 사용하지 않고 매번 정보가 전송되는 것은 사용자뿐 아니라 서버에도 부담
- 지리적으로 분산된 여러 개의 서버를 이용해 웹 콘텐츠를 사용자와 가까운 서버에서 전송함으로써 전송 속도를 높인다.
- 서버가 데이터를 전 세계 각지에 세워진 캐시 저장 및 전달용 컴퓨터(cdn 업체 소유)로 보내면 사용자는 본인에게서 가장 가까운 캐시 서버로 요청을 보내고 데이터를 받아 온다.

## 2. 웹 스토리지
- 클라이언트의 데이터를 저장할 수 있도록 HTML5부터 새롭게 지원하는 저장소로, key-value 형태로 데이터를 저장한다.
- 서버에 전송되지 않아 서버에 부담이 가지 않는다.
- 도메인 단위로 접근이 제한되는 특성이 있어 다른 도메인에서 요청해도 값을 꺼내 쓸 수 없다. (CSRF 안전)
- 최대 5MB의 정보를 저장할 수 있다.
- 문자열 뿐 아니라 JavaScript의 primitives object도 저장할 수 있다.
- javascript primitive data type
  - 원시 값, 원시 자료형
  - 객체가 아니면서 메서드도 가지지 않는 데이터
    - string, number, bigint, boolean, undefined, symbol, null
- 종류: sessionStorage / localStorage (데이터의 유효성, 라이프사이클)
- 사생활 보호 모드 / 시크릿 모드인 경우, 브라우저를 닫으면 저장한 데이터를 제거한다.
  - Safari의 경우 Web Storage api는 존재하지만 최대 용량을 0바이트로 할당해 어떠한 데이터도 입력할 수 없도록 한다.

### sessionStorage
- window.sessionStorage 객체
- 탭/윈도우를 닫을 시 데이터가 삭제된다.
- 탭/윈도우 단위로 세션 스토리지가 생성된다.
  - 동일한 탭/윈도우라도 다른 도메인이라면 또 다른 세션 스토리지가 생성된다.
  - 서로 다른 세션 스토리지는 서로 영향을 주지 않으며 독립적으로 동작한다.
  - 윈도우 복제로 생성된 경우, 혹은 스크립트로 새 창을 연 경우 세션 스토리지가 복제되어 생성된다.
- 잠시 동안 필요한 정보를 저장하기에 좋다. (입력 폼 저장, 일회성 로그인)
- 같은 사이트의 도메인이라도 브라우저가 다르면 서로 다른 영역이 된다.

### localStorage
- window.localStorage 객체
- 브라우저를 종료해도 유지되는 데이터로, 명시적으로 지우지 않는 한 영구적으로 저장된다.
- 도메인 단위로 로컬 스토리지가 생성된다.
  - 서로 다른 브라우저 탭이라도 동일한 도메인이라면 동일한 로컬 스토리지를 공유한다.
  - 다른 도메인의 로컬 스토리지에는 접근이 불가능하다.
- 지속적으로 필요한 정보를 저장하기에 좋다. (자동 로그인)

## 3. IndexedDB
- IndexedDB는 파일이나 블롭 등 많은 양의 구조화된 데이터를 클라이언트에 저장하기 위한 로우 레벨 API
- 트랜잭션 데이터베이스 시스템, JavaScript 기반 객체 지향 데이터베이스
- 인덱스를 사용해 데이터를 고성능으로 탐색할 수 있다.
- Web Storage는 적은 양의 데이터를 저장하는데 유용하지만 많은 양의 구조화된 데이터에는 적합하지 않은데, 이런 상황에서 IndexedDB를 사용할 수 있다.
- 핵심 개념과 사용
  - 트랜잭션을 사용하는 JavaScript 기반의 객체지향 데이터베이스
  - 인덱스 키를 이용해 저장하고 검색할 수 있으며, 구조화된 복사 알고리즘(https://developer.mozilla.org/ko/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)을 지원하는 객체라면 모두 저장할 수 있다.
  - 사용하려면 데이터베이스 스키마를 지정하고, 데이터베이스와 통신을 연 후에, 일련의 트랜잭션을 통해 데이터를 가져오거나 업데이트해야 한다.
- IndexedDB 작업은 모두 비동기로 이루어진다.
- IndexedDB 용량 제한은 특별히 없으나, 브라우저에 따라 저장 용량 한도와 용량이 한계에 도달했을 때 어떤 데이터를 제거할 것인지 프로세스는 다를 수 있다. (https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Browser_storage_limits_and_eviction_criteria)
- 보다 단순한 api를 선호한다면 라이브러리를 활용할 수 있다. (https://developer.mozilla.org/ko/docs/Web/API/IndexedDB_API, See also)
